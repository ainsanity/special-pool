<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Contract Settlement Tool</title>

<style>
body { font-family: Arial; background:#f4f6f9; padding:20px }
input, button { padding:8px; font-size:14px }
button { margin-left:5px }
.summary, table {
  background:#fff; padding:15px; border-radius:8px; margin-top:15px
}
table { width:100%; border-collapse:collapse }
th,td { padding:8px; border:1px solid #ddd; text-align:center }
th { background:#2c3e50; color:#fff }
.gnpa { color:red; font-weight:bold }
.non { color:green; font-weight:bold }
.manager { color:#e67e22; font-weight:bold }
#error { color:red; font-weight:bold; margin-top:10px }
</style>
</head>

<body>

<h2>Search Contract</h2>

<input id="contractInput" placeholder="Enter Contract No">
<button onclick="searchContract()">Search</button>

<div id="error"></div>
<div class="summary" id="summary"></div>

<table id="tbl" style="display:none">
<thead>
<tr>
<th>Contract No</th>
<th>GNPA</th>
<th>Seasoning %</th>
<th>Balance Jan-26</th>
<th>Settlement</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
let customers = [];
let contracts = [];
let dataLoaded = false;

/* ========== LOAD JSON ========== */
fetch("output.json")
  .then(r => r.json())
  .then(d => {
    customers = d.customers;
    contracts = d.contracts;
    dataLoaded = true;
    console.log("Loaded contracts:", contracts.length);
  });

/* ========== SETTLEMENT ========== */
function settlement(seasoning, balance, lsa) {
  if (lsa === "YES") return "Contact Manager";
  if (seasoning >= 60) return Math.round(balance * 0.75);
  if (seasoning >= 30) return Math.round(balance * 0.55);
  return Math.round(balance * 0.40);
}

/* ========== SEARCH ========== */
function searchContract() {
  document.getElementById("error").innerText = "";
  document.getElementById("tbl").style.display = "none";

  if (!dataLoaded) {
    document.getElementById("error").innerText = "Data still loading. Try again.";
    return;
  }

  const input = document.getElementById("contractInput").value.trim();
  if (!input) {
    document.getElementById("error").innerText = "Enter Contract No";
    return;
  }

  const found = contracts.find(c =>
    String(c.contract_no).trim().toUpperCase() === input.toUpperCase()
  );

  if (!found) {
    document.getElementById("error").innerText = "âŒ Contract not found";
    return;
  }

  const customer = customers.find(x => x.customer_id === found.customer_id);
  const linked = contracts.filter(x => x.customer_id === found.customer_id);

  document.getElementById("summary").innerHTML = `
    <b>Customer:</b> ${customer.customer_name}<br>
    <b>Total Contracts:</b> ${linked.length}<br>
    <b>GNPA:</b> ${linked.filter(x=>x.gnpa_flag==="YES").length}<br>
    <b>Non GNPA:</b> ${linked.filter(x=>x.gnpa_flag!=="YES").length}<br>
    <b>LSA:</b> ${customer.lsa_flag==="YES" ? linked.length : 0}
  `;

  document.getElementById("tbody").innerHTML = linked.map(c => `
    <tr>
      <td>${c.contract_no}</td>
      <td class="${c.gnpa_flag==="YES"?"gnpa":"non"}">${c.gnpa_flag}</td>
      <td>${c.seasoning_pct}</td>
      <td>${c.contract_balance_jan_26}</td>
      <td>${settlement(c.seasoning_pct,c.contract_balance_jan_26,customer.lsa_flag)}</td>
    </tr>
  `).join("");

  document.getElementById("tbl").style.display = "table";
}
</script>

</body>
</html>
